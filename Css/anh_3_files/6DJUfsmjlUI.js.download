;/*FB_PKG_DELIM*/

__d("EBLSDeferred",["requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("EBLS").__setRef("EBLSDeferred");function a(){return h.load().then(function(a){return a.init()})}function b(){return h.load().then(function(a){return a.genLSClient()})}function d(){return h.load().then(function(a){return a.getLSStorage()})}function e(a,b,c){return h.load().then(function(d){return d.platformClientInit(a,b,c)})}g.init=a;g.genLSClient=b;g.getLSStorage=d;g.platformClientInit=e}),98);
__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.mediaType,e=a.msgType,f=a.probeDelayMs,g=a.restoreMethod;a=a.sampleRate;return d("MAWQplProxy").startQplUserFlow(c("qpl")._(521473213,"27"),{"int":{probeDelayMs:f,sampleRate:a},string:{mediaType:b,msgType:e,restoreMethod:g}},void 0,c("justknobx")._("3047"))}g.startMediaRestoreProbeQPLFlow=a}),98);
__d("EncryptedBackupsResignCdnUrl",["MAWBridge","MAWConfig","MAWLoggerUtils","WAJids","WAResolvable","WAResultOrError","asyncToGeneratorRuntime","cr:10071"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function a(a){return h.get(a)}function c(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.deliveryObjectId,e=a.mediaType,f=a.msgId,g=a.protocolMsgId;a=a.sortOrderMs;if(b("cr:10071")!==null){var i=(yield b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:g.chat,deliveryObjectId:c,externalId:g.externalId,mediaType:e,sortOrderMs:a}));return!i.success?i:d("WAResultOrError").makeResult(i.value)}else{i=d("MAWLoggerUtils").getInstanceKey();var j=new(d("WAResolvable").Resolvable)();h.set(i,j);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:c,mediaType:e,messageId:g.externalId,msgId:f,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,skipLegacyMediaDownloadFlow:!0,sortOrder:a,threadId:d("WAJids").threadIdForChatJid(g.chat),threadJid:g.chat,traceId:i}}]});return j.promise}});return i.apply(this,arguments)}g.getRestoredCdnUrlResolvable=a;g.resignCdnUrl=c}),98);
__d("MAWGetMediaApi",["MAWDbMediaTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot find xma with xmaId ",""]);h=function(){return a};return a}b=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READONLY},"getMediaByPlaintextHash",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b)}});c=d("MAWIndexedDb").makeMsgrTransactor({media:a.READONLY},"getMediaByMediaId",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b)}});e=d("MAWIndexedDb").makeMsgrTransactor({media:a.READONLY,xma:a.READONLY},"getMediaByXMAId",function(a){return function(b,c){return a.xma.get(b).then(function(e){if(e==null){c.ERROR(h(),b);return[]}return d("MAWDexieTable").dexieAll([d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.defaultPreviewMediaId),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.headerMediaId),d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,e.faviconMediaId)])})}});g.getMediaByPlaintextHash=b;g.getMediaByMediaId=c;g.getMediaByXMAId=e}),98);
__d("MAWGetMsgByProtocolIdApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"getMsgsByProtocolMsgIdsTxn",function(a){return function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b)}});g.getMsgsByProtocolMsgIdsTxn=a}),98);
__d("MAWDeletedMsgApi",["MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({deletedMessages:d("MAWTransactionMode").READONLY},"getDeletedMsgByProtocolIdApi",function(a){return function(b){return a.deletedMessages.get(babelHelpers["extends"]({},b))}});g.getDeletedMsgByProtocolIdApi=a}),98);
__d("MAWIsMsgDeletedWithReason",["MAWDbDeletedMessages","MAWDeletedMsgApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("MAWDeletedMsgApi").getDeletedMsgByProtocolIdApi(a));return!a?!1:a.reason===d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.ChatDelete||a.reason===d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke});return h.apply(this,arguments)}g.isMsgDeletedWithReason=a}),98);
__d("EncryptedBackupsMediaRestoreProbe",["EncryptedBackupsMediaRestoreProbeQpl","EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWDbXMATxns","MAWGetMediaApi","MAWGetMsgByProtocolIdApi","MAWIndexedDb","MAWIsMsgDeletedWithReason","MAWMsgType","MAWTransactionMode","Promise","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["restore media success for ",". mediaType: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["failed to restore media for ",". mediaType: ",", error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["unsupported media type ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["sortOrderMs is required for media restore, but not found for ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["no dbMsg found for ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["msg is deleted"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["start probe media backup through ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot find media for xma with protocolMsgId ",""]);q=function(){return a};return a}var r=d("WATagsLogger").TAGS(["MediaRestoreProbe"]),s=c("justknobx")._("2045");function a(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.uploadEntity;var c=A(),e=Math.random()<c/100;if(!e)return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult("not-sampled"));var f=b("cr:10071")==null?"sproc":"gql";r.LOG(p(),f);yield d("WAPromiseDelays").delayMs(s);var g=a.msgId;e=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([g]));var i=e[0];if(i==null){a=(yield d("MAWIsMsgDeletedWithReason").isMsgDeletedWithReason(g));if(a){r.LOG(o());return d("WAResultOrError").makeResult("msg-deleted")}r.ERROR(n(),g);return d("WAResultOrError").makeError("missing-db-msg")}e=(yield x({dbMsg:i,protocolMsgId:g}));if(e.type==="no-attachment"){r.LOG(m());return d("WAResultOrError").makeResult("no-attachment-with-msg")}a=u(e,i.msgId);if(!a.success)return d("WAResultOrError").makeError([a.error]);e=a.value;a=(yield (h||(h=b("Promise"))).all(e.map(function(a){var b=d("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({mediaType:a.serverMediaType,msgType:i.type,probeDelayMs:s,restoreMethod:f,sampleRate:c});return v({dbMsg:i,payload:a,protocolMsgId:g}).then(function(a){if(a.success){b.endSuccess();return a}b.endFail(a.error,{string:{failReason:a.error}});return a})["catch"](function(a){b.endFail("runtime-error",{string:{failReason:a.toString()}});return d("WAResultOrError").makeError("runtime-error")})})));e=a.map(function(a){return a.success?null:a.error}).filter(Boolean);return e.length>0?d("WAResultOrError").makeError(e):d("WAResultOrError").makeResult("restore-media-success")});return t.apply(this,arguments)}function u(a,b){var c=[],e=a.type==="xma"?a.medias:[a];e.forEach(function(a){a=a.fullsize;a=a.mediaEntries.get(b);if(a==null)return d("WAResultOrError").makeError("missing-media-entry");a=d("WAMediaUtils").decodeMediaEntryData(a);var e=a.objectId;a=a.serverMediaType;c.push({objectId:e,serverMediaType:a})});a.type==="media-with-preview"&&c.push({objectId:a.preview.objectId,serverMediaType:"preview"});return d("WAResultOrError").makeResult(c)}function v(a){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg,c=a.payload;a=a.protocolMsgId;var e=b.msgId,f=b.sortOrderMs;if(f==null){r.ERROR(l(),a);return d("WAResultOrError").makeError("missing-sort-order-ms")}var g=c.objectId;c=c.serverMediaType;if(c==null||g==null)return d("WAResultOrError").makeError("invalid-media-entry");b=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(c,b.type===d("MAWMsgType").MSG_TYPE.XMA);if(b==null){r.ERROR(k(),c);return d("WAResultOrError").makeError("unsupported-media-type")}c=(yield d("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:g,mediaType:b,msgId:e,protocolMsgId:a,sortOrderMs:f}));if(!c.success){r.ERROR(j(),a,b,c.error);return c}r.LOG(i(),a,b);return d("WAResultOrError").makeResult("restore-media-success")});return w.apply(this,arguments)}function x(a){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.dbMsg;a=a.protocolMsgId;switch(b.type){case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:if(b.plaintextHash==null)return{type:"no-attachment"};var e=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(b.plaintextHash));if(c("gkx")("6038")&&e!=null){var f=e==null?void 0:e.mediaEntries.get(b.msgId);if(f!=null){f=d("WAMediaUtils").decodeMediaEntryData(f).downloadableThumbnail;if(f!=null)return{fullsize:e,preview:f,type:"media-with-preview"}}}return e==null?{type:"no-attachment"}:{fullsize:e,type:"media"};case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:if(b.plaintextHash==null)return{type:"no-attachment"};f=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(b.plaintextHash));return f==null?{type:"no-attachment"}:{fullsize:f,type:"media"};case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:case d("MAWMsgType").MSG_TYPE.ADMIN:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return{type:"no-attachment"};default:b.type;e=(yield z(a));return e.length===0?{type:"no-attachment"}:{medias:e.map(function(a){return{fullsize:a}}),type:"xma"}}});return y.apply(this,arguments)}var z=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},"getMediaByXMAId",function(a){return function(b){return d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,b).then(function(a){if(!a.success){r.ERROR(q(),b);return[]}a=a.value;var c=a.defaultPreview,d=a.favicon,e=a.header;a=a.previews;return[c,d,e].concat(a==null?[]:a).filter(Boolean)})}});function A(){return c("gkx")("2067")?100:c("justknobx")._("2722")}g.sampleProbeMediaRestore=a}),98);
__d("MAWEBScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("eb",{concurrency:1,maxConcurrency:1,maxThrottleMs:1e3,timeToStuckMs:3e4}));return h}g.ebScheduler=a}),98);
__d("MAWEbUploadQueue",["EBUploadMessages","EncryptedBackupsMediaRestoreProbe","EncryptedBackupsUploadQueue","EncryptedBackupsUtils","MAWBridge","MAWEBScheduler","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWGetMsgByProtocolIdApi","WAGetSafeQPLError","WAGlobals","WAJids","WAPromiseBackoffs","WAShiftTimer","WATimeUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","gkx","justknobx","promiseDone","setInterval"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestore: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot get message from db: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found 2"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg not found 1"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"]);o=function(){return a};return a}var p=d("EncryptedBackupsUploadQueue").logger.TAGS(["labyrinth-web"]),q=new Map(),r=new Map(),s=new Set(),t={algo:{first:c("justknobx")._("2366"),type:"exponential"},max:d("WATimeUtils").HOUR_MILLISECONDS},u=d("WAPromiseBackoffs").createTimer(t);a=u();c("setInterval")(e,1e3);var v=new(d("WAShiftTimer").ShiftTimer)(f),w=null;function x(){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("WAWaitForUserUnblocked").waitForUserUnblocked();var e=!0;if(w!=null)return;w=d("MAWEBScheduler").ebScheduler().task({fn:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("MAWEBSwitch").isEnabled()){var a=(yield C());a=a.isEmpty;e=!a}else d("MAWEBUploadTrackingUtils").getUploadQueueStartedCache().forEach(function(a,b){d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(b)}),e=!1});function f(){return a.apply(this,arguments)}return f}(),name:"eb_upload",priority:d("WorkerScheduler").BACKGROUND_PRIORITY});w.run().then(function(){u=d("WAPromiseBackoffs").createTimer(t),a=u(),w=null,e&&void x()})["catch"](function(b){w=null,p.ERROR(k(),b),q.forEach(function(a,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(b)}})}),q.clear(),e&&(a=u(),window.setTimeout(function(){void x()},c("justknobx")._("2366")+a))})});return y.apply(this,arguments)}function e(){var a=d("WATimeUtils").performanceAbsoluteNow();s.forEach(function(b){a-b>c("justknobx")._("2366")&&(s["delete"](b),c("promiseDone")(z()))});var b=[];for(var e of r){var f=e[0],g=e[1];s.has(g)||b.push(f)}b.forEach(function(a){return r["delete"](a)})}function f(){c("MAWEBSwitch").isEnabled()?void C()["catch"](function(a){p.ERROR(o(),a),q.forEach(function(b,c,e){d("MAWEBUploadTrackingUtils").endFailWorkerOnly(c,"upload_eb_msgs_error",{string:{reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}),q.clear(),v.onOrAfter(c("justknobx")._("2366"))}):(d("MAWEBUploadTrackingUtils").getUploadQueueStartedCache().forEach(function(a,b){d("MAWEBUploadTrackingUtils").removeExternalIdFromUploadQueueStartedCache(b)}),v.onOrAfter(c("justknobx")._("2366")))}function z(){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("gkx")("5625")){c("promiseDone")(x());return}yield d("WAWaitForUserUnblocked").waitForUserUnblocked();v.onOrBefore(c("justknobx")._("2367"))});return A.apply(this,arguments)}function B(){c("MAWEBSwitch").onSet(function(){c("MAWEBSwitch").isEnabled()&&c("promiseDone")(z())});c("promiseDone")(z());var a=d("EncryptedBackupsUploadQueue").ebUploadQueue();a.subscribe(function(a){a.type==="flush"&&c("promiseDone")(z())})}function C(){return D.apply(this,arguments)}function D(){D=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("EncryptedBackupsUploadQueue").ebUploadQueue(),b=[],e=(yield a.read({filter:function(a){if(a.sortOrderMs==null||d("EncryptedBackupsUtils").entryOlderThan30Days(a.sortOrderMs)){b.push(a.queueId);return!1}else return!q.has(d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(a.msgId))},limit:c("justknobx")._("2368"),order:"desc"}));yield a["delete"](b);if(e.length===0)return{isEmpty:!0};p.LOG(j(),e.length);a=e.map(function(a){var b;return{backupActionType:a.backupActionType,msgId:a.msgId,originalMsgProtocolId:(b=a.backupDirective)==null?void 0:b.originalMsgProtocolId,protobuf:a.protobuf,senderId:a.senderId,serverTs:a.serverTs,sortOrderMs:a.sortOrderMs,supplementalKey:a.supplementalKey}});var f=new Map(),g=[],h=[],k=new Map(),l=new Map();for(var m of e)if(m.originalMsgProtocolId.author!=null){var n,o=m.originalMsgProtocolId.author,t=m.originalMsgProtocolId.chat;o={author:d("WAGlobals").getMyUserJid()===m.originalMsgProtocolId.author?d("WAJids").AUTHOR_ME:o,chat:t,externalId:m.backupActionType===4?m.msgId.externalId:m.originalMsgProtocolId.externalId};t=d("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(m.msgId);q.set(t,m.queueId);k.set(o.externalId,(n=m.attachmentContext)!=null?n:h);n=m.msgId.externalId;var u=m.originalMsgProtocolId.externalId;n!==u&&l.set(n,{currentExternalId:n,originalMsgExternalId:u});if(!f.has(o.externalId)){f.set(o.externalId,t);n=d("MAWEBUploadTrackingUtils").getAndRemoveFromUploadQueueStartedCache(m.msgId.externalId);d("MAWEBUploadTrackingUtils").startUploadTracking(o.externalId,n==null?void 0:n.msgType,n==null?"uploadqueue":o.externalId===d("WAJids").AUTHOR_ME?"send":"receive",t,!0);g.push(o)}}else c("promiseDone")(d("EncryptedBackupsUploadQueue").ebUploadQueue().ack([m.queueId]));f.forEach(function(a,b){d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a,"queue_get_original_msg_ids_done")});d("EBUploadMessages").logIfExtIdsNotInAttachmentContextArrayMap(k,g.map(function(a){return{extId:a.externalId}}),"after_originalMsgIdArray",f);u=(yield d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn(g)["catch"](function(a){g.forEach(function(b){b=f.get(b.externalId);b!=null?d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,"get_db_msgs_error",{string:{reason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}}):p.WARN(i(),a)});throw a}));var w=d("WATimeUtils").performanceAbsoluteNow();s.add(w);var x=new Map();u.forEach(function(a){var b=f.get(a.externalId);if(b==null)return;r.set(b,w);d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"queue_get_msgs_done");var c=l.get(a.externalId);c!=null&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(b,"external_id_mismatch",{string:{currentExternalId:c.currentExternalId,differing_ids_type:a.type,originalMsgExternalId:c.originalMsgExternalId}});x.set(a.externalId,(b=k.get(a.externalId))!=null?b:h)});G(f,g,u);d("EBUploadMessages").logIfExtIdsNotInAttachmentContextArrayMap(k,u.map(function(a){return{extId:a.externalId,type:a.type}}),"after_msgArray",f);var y=[];e.forEach(function(a){a.legacyAttachmentContext!=null&&a.legacyAttachmentContext.forEach(function(a){y.push({tag:"UploadAttachment",value:a})})});y.length>0&&d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:y});yield d("EBUploadMessages").uploadMessageFromUploadQueue(u,f,a,x);c("gkx")("5625")||v.onOrBefore(c("justknobx")._("2366"));return{isEmpty:!1}});return D.apply(this,arguments)}function E(a,b){return F.apply(this,arguments)}function F(){F=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=d("EncryptedBackupsUploadQueue").ebUploadQueue();b?d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(a,"upload_queue_ack_worker_success"):d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"upload_queue_ack_worker_fail");var f=r.get(a);f!=null&&(r["delete"](a),s["delete"](f));var g=q.get(a);if(g==null)return;if(b){f=(yield e.read({filter:function(a){return a.queueId===g},limit:1}));b=f[0];if(b==null)return;void d("EncryptedBackupsMediaRestoreProbe").sampleProbeMediaRestore({uploadEntity:b})["catch"](function(a){p.ERROR(h(),a)})}yield e.ack([g]);q["delete"](a);c("promiseDone")(z())});return F.apply(this,arguments)}function G(a,c,e){if(c.length>e.length){var f=new Set(c.map(function(a){return a.externalId}));e.forEach(function(b){if(f.has(b.externalId)){f["delete"](b.externalId);var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{originalMsgType:b.type}}):p.WARN(n())}});f.forEach(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=a.get(b);if(b!=null){d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(b,"upload_queue_msg_not_found");var c=q.get(b);q["delete"](b);if(c==null)return;yield d("EncryptedBackupsUploadQueue").ebUploadQueue()["delete"]([c])}else p.WARN(m())});return function(a){return c.apply(this,arguments)}}())}else e.forEach(function(b){var c=a.get(b.externalId);c!=null?d("MAWEBUploadTrackingUtils").addPointWorkerOnly(c,"msg_found",{string:{originalMsgType:b.type}}):p.WARN(l())})}g.scheduleNextRun=z;g.listenForEbUploadQueueFlush=B;g.uploadEBMsgs=C;g.ackWithInstanceKey=E}),98);
__d("WorkerBootstrap",["HasteSupportData","ServerJSDefine"],(function(a,b,c,d,e,f,g){"use strict";function h(a){Object.keys(a).forEach(function(b){c("ServerJSDefine").handleDefine(b,[],a[b],-1,null)})}function a(a,c){var f,g;a.hsdp&&d("HasteSupportData").handle(a.hsdp);var i=(f=(g=a.jsmods)!=null?g:a.dynamicModules)!=null?f:{};h(i);var j=b.call(null,c);a.rds!=null&&a.rds.length>0&&e.call(null,a.rds,function(){});if(typeof j==="function"||j!==null)try{for(var k=arguments.length,l=new Array(k>2?k-2:0),m=2;m<k;m++)l[m-2]=arguments[m];j.apply(void 0,l)}catch(a){}}function f(a){a=a;if(typeof a==="function"||a!==null)try{a()}catch(a){}}g.initDynamicModules=h;g.start=a;g.startServerJS=f}),98);